# 图片嵌入功能说明

## 概述

现在您的金融数据分析系统已经支持在邮件正文中直接嵌入分析结果图片。这大大提升了邮件的可读性和用户体验，收件人可以直接在邮件中查看图表，无需下载附件。

## 功能特性

### 1. 自动图片检测
- 系统会自动扫描 `analysis_results/` 目录
- 查找所有PNG格式的分析结果图表
- 智能选择最重要的图表嵌入到邮件正文中

### 2. 智能图片选择
系统会优先选择以下类型的图片嵌入到邮件中：
- `combined_analysis` - 日线和周线的总和分析图表
- 自动识别周线和日线数据，提供更精准的分析结果展示

### 3. HTML邮件格式
- 邮件内容采用HTML格式，更加美观
- 图片直接嵌入在邮件正文中，支持响应式布局
- 包含分析结果概览、图表展示和说明

### 4. 图片嵌入技术
- 使用MIME multipart/related格式
- 图片通过Content-ID引用，确保正确显示
- 支持多种图片格式（PNG、JPG等）

## 使用方法

### 测试图片嵌入功能

#### 方法1：使用完整测试脚本
```bash
python3 test_email.py
```
这个脚本会：
1. 测试邮件配置
2. 测试SMTP连接
3. 发送带嵌入图片的测试邮件

#### 方法2：使用简单测试脚本
```bash
python3 test_with_images.py
```
这个脚本专门测试图片嵌入功能，更加简洁。

### 运行分析并发送邮件

#### 单次运行（测试）
```bash
python3 main_scheduler.py --mode once
```

#### 定时运行
```bash
python3 main_scheduler.py --mode schedule
```

## 邮件内容说明

### 正常分析邮件
- **主题**: 金融数据分析报告 - YYYY-MM-DD
- **内容**: HTML格式，包含分析概述、嵌入的图表和结果说明
- **图片**: 直接嵌入在邮件正文中，最多2个总和分析图表（日线和周线）
- **发送时间**: 每天下午3:05（定时模式）

### 错误通知邮件
- **主题**: 金融数据分析任务执行失败 - YYYY-MM-DD
- **内容**: 纯文本格式，包含错误信息和时间
- **图片**: 无
- **发送时间**: 分析失败时立即发送

## 图片文件结构

```
analysis_results/
├── W/                          # 周线分析结果
│   ├── 399006.SZ_周线_combined_analysis.png
│   ├── 399006.SZ_周线_residual_cycles.png
│   └── 399006.SZ_周线_linear_residuals.png
├── D/                          # 日线分析结果
│   ├── 399006.SZ_日线_combined_analysis.png
│   ├── 399006.SZ_日线_residual_cycles.png
│   └── 399006.SZ_日线_linear_residuals.png
└── step13_transparency.png     # 透明度分析
```

## 配置要求

### 1. 环境变量 (.env文件)
```env
EMAIL_SENDER=your_email@163.com
NETEASE_EMAIL_PASSWORD=your_authorization_password
SMTP_SERVER=smtp.163.com
SMTP_PORT=465
```

### 2. 邮件接收者 (email_recipients.json)
```json
{
    "recipients": [
        "recipient1@example.com",
        "recipient2@example.com"
    ]
}
```

## 故障排除

### 常见问题

1. **图片不显示**
   - 确认邮件客户端支持HTML格式
   - 检查图片文件是否存在且可读
   - 查看日志文件确认图片嵌入状态

2. **邮件发送失败**
   - 检查网络连接
   - 确认邮箱配置正确
   - 查看日志文件获取详细错误信息

3. **图片过大导致邮件发送失败**
   - 系统会自动选择最重要的图片
   - 避免嵌入过多图片
   - 考虑压缩图片文件

### 日志查看
```bash
tail -f analysis.log
```

## 最佳实践

### 1. 图片文件管理
- 定期清理旧的图片文件
- 保持图片文件大小合理（建议 < 500KB）
- 使用有意义的文件名

### 2. 邮件接收者管理
- 定期更新接收者列表
- 避免添加过多接收者
- 确保接收者邮箱支持HTML格式

### 3. 测试建议
- 首次使用前先运行测试脚本
- 定期测试邮件功能
- 监控日志文件确保系统正常运行

## 技术细节

### 图片嵌入原理
1. 扫描指定目录中的图片文件
2. 将图片转换为MIME格式
3. 设置Content-ID用于HTML引用
4. 使用multipart/related格式发送邮件

### 邮件发送策略
- 每个接收者单独发送
- 支持HTML和纯文本格式
- 自动错误处理和重试
- 详细的日志记录

### 图片选择算法
1. 扫描所有PNG文件
2. 优先选择 `combined_analysis` 类型的图片
3. 自动识别周线和日线数据
4. 选择最多2个总和分析图片（日线和周线）
5. 避免重复嵌入相同图片

## 优势对比

### 图片嵌入 vs 附件发送

| 特性 | 图片嵌入 | 附件发送 |
|------|----------|----------|
| 用户体验 | 直接在邮件中查看 | 需要下载后查看 |
| 邮件大小 | 较大 | 较小 |
| 兼容性 | 需要HTML支持 | 所有邮件客户端 |
| 安全性 | 图片直接可见 | 需要用户操作 |
| 加载速度 | 较慢 | 较快 |

## 更新日志

- **v1.0**: 基础邮件发送功能
- **v2.0**: 添加图片附件支持
- **v3.0**: 升级为图片嵌入功能
- **v3.1**: 优化图片选择算法
- **v3.2**: 改进HTML邮件格式和样式

## 技术支持

如果遇到问题，请：
1. 查看日志文件
2. 运行测试脚本
3. 检查配置文件
4. 确认网络和邮箱服务状态
5. 验证邮件客户端是否支持HTML格式
